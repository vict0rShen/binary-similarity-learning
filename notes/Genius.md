# Genius——<u>G</u>raph <u>En</u>coding for B<u>u</u>g <u>S</u>earch

| Target（目标）     | 已知某个bug，在其他物联网固件中检索具有相同问题的固件        |
| :----------------- | :----------------------------------------------------------- |
| Input（输入）      | 二进制程序（函数级）                                         |
| Process（处理）    | 1. 特征提取：从二进制中提取属性控制流图（ACFG）<br />2. “密码本”生成：利用二分图匹配方法计算图间相似度，将聚类后簇的几何中心作为编码基准<br />3. 特征编码：使用VLAD嵌入完成ACFG在高维空间中的编码<br />4. 在线搜索：使用局部敏感哈希对编码后的特征进行搜索 |
| Output（输出）     | 与输入函数相近的函数的列表                                   |
| Problem（问题）    | 解决的问题：<br />1. bug搜索过程由多次一对一相似度匹配构成，搜索效率低<br />2. 现有方法的相似度分析主要依赖图结构的相似度匹配，面对跨架构搜索问题时准确率低 |
| Condition（条件）  | 程序可被正常反编译                                           |
| Difficulty（难点） | 如何构造包含二进制程序结构与语义信息的特征编码               |
| Level（水平）      | CCS2016                                                      |

## 算法原理

### 算法原理图

![image-approach_overview](./image/Genius/image-20221017104002392.png)

### 特征提取

#### 属性控制流图（Attributed Control Flow Graph）

一个有向图 $G=\langle V,E,\phi \rangle$ ，其中 $V$ 是基本块集合， $E\subseteq V \times V$ 表示基本块之间边的集合， $\phi : V\rightarrow \sum$ 为基本块到属性集合的映射函数。

#### ACFG生成方法

在CFG的基础上添加每个基本块的属性特征，属性特征由统计特征和结构特征两部分组成，特征列表如下表所示。

部分特征说明：

- No. of offspring：控制流图中该节点的子节点个数
- Betweeness：节点的[介数中心性](../concept.md#介数中心性)

![image-basic-block_level_features](./image/Genius/image-20221017172441347.png)

### “密码本”生成

“密码本”（codebook）是一个有限离散集合，其中每个元素均为一个聚类簇的几何中心。

#### ACFG相似度计算

##### [二分图](../concept.md#二分图)匹配

利用两个ACFG $G_1$ 与 $G_2$ 构造二分图 $G_{bp}=(\hat V,\hat E)$ ，其中 $G_1$ 、 $G_2$ 的节点（代码块）分属于 $\hat V$ 的两个不相交集。

使用两个ACFG之间的最小匹配损失计算这两个图之间的相似度，一条匹配边的损失函数记为：

$$cost(v,\hat v)=\frac{\sum_i\alpha_i|a_i-\hat a_i|}{\sum_i\alpha_i\max(a_i,\hat a_i)}$$

其中 $a_i$ 和 $\hat a_i$ 分别表示进行匹配的两个基本块的第 $i$ 个特征， $\alpha$ 为上表中的权重。

##### 标准化

越复杂的ACFG之间通常会具有越大的匹配损失，因此需要对匹配损失做标准化。设置一个空的ACFG $\phi$ ，则ACFG间的相似度可记为：

$$\kappa (g_1,g_2)=1-\frac{cost(g_1,g_2)}{\max(cost(g_1,\phi),cost(g_2,\phi))}$$

##### 实现

实际实现过程中，使用discovre的方法计算各个特征的权重。

#### 聚类

使用谱聚类（核化）对ACFG进行聚类。为减少时间开销，对数据集进行了采样；采样时按照ACFG大小进行分级，避免因采样偏差影响聚类效果。

聚类数量人工选定为16。

### 特征编码

定义 $NN(g_i)$ 为ACFG $g_i$ 最近的 $n$ 个聚类簇几何中心，其中 $\mathcal{C}$ 表示“密码本”：

$$NN(g_i)=\arg \max\limits_{c_j\in \mathcal{C}}\kappa(g_i,c_j)$$

#### “特征袋”嵌入

类比了词袋（bag-of-words）嵌入，嵌入表示为：

$$q(g_i)=\sum\limits_{g_i:NN(g_i)=c_j}[\mathbb{1}(1=j),\cdots,\mathbb{1}(n=j)]^T$$

即将离ACFG最近的 $n$ 个聚类簇几何中心的 one-hot 编码相加

#### VLAD嵌入

在“特征袋”嵌入的基础上额外考虑ACFG到聚类簇几何中心的距离：

$$q(g_i)=\sum\limits_{g_i:NN(g_i)=c_j}[\mathbb{1}(1=j)\kappa(g_i,c_1),\cdots,\mathbb{1}(n=j)\kappa(g_i,c_n)]^T$$

本文使用此类嵌入方法

### 在线搜索

使用局部敏感哈希对嵌入向量进行哈希，随后使用欧氏距离/余弦距离进行距离计算

## 笔者总结

创新性主要体现在：

- 在节点属性中增加图结构信息
- 使用二分图匹配计算图之间的相似性
- 引入”嵌入“思想

可能存在的问题：

- 依赖提取出的统计特征和结构特征是否能够全面描述一个控制流图？在二分图匹配过程中直接舍弃了节点间的连接信息，仅依赖提取的特征进行匹配
- 似乎缺乏语义信息的提取与分析
- 缺乏对于跨架构二进制程序的细节分析以及针对性优化
